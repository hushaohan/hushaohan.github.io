%!TEX root = cv.tex
\section{\sc Publications}

\begin{luacode*}
tex.sprint([[\begin{longtabu}{p{.55\sectionwidth} p{.77\resumewidth}}]])

function get_venue(publication)
    if publication.journal ~= nil then
        return publication.journal
    elseif publication.conference ~= nil then
        return publication.conference
    else
        return publication.preprint
    end
end

function render_venue(venue)
    local months = {"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"}
    local venue_items = {}
    table.insert(venue_items, string.format("\\href{%s}{\\textsf{%s (%s)}}", venue.url, venue.name, venue.acronym))
    if venue.volume ~= nil then
        table.insert(venue_items, string.format("Volume %d, Number %d", venue.volume, venue.number))
    end
    if venue.location ~= nil then
        table.insert(venue_items, venue.location)
    end
    if venue.date ~= nil then
        table.insert(venue_items, venue.date)
    else
        table.insert(venue_items, months[venue.month])
    end
    table.insert(venue_items, venue.year)
    return table.concat(venue_items, ', ')
end

function render_authors(authors)
    return string.gsub(
        table.concat(authors, ', '),
        "Shaohan Hu",
        "\\textbf{Shaohan Hu}",
        1
    )
end

function render_publications(publications)
    local publications_strs = {}
    for _, publication in ipairs(publications)
    do
        local venue = get_venue(publication)
        local publication_str = string.format("{\\sc %s %d} & %s, \\href{%s}{\\emph{%s}}, %s",
            venue.acronym,
            venue.year,
            render_authors(publication.authors),
            publication.url,
            publication.title,
            render_venue(venue)
        )
        if publication.award ~= nil then
            publication_str = publication_str .. string.format(". (\\textbf{%s})", publication.award)
        end
        if publication.journal ~= nil and publication.conference ~= nil then
            publication_str = publication_str .. string.format(
                ". (Presented at \\href{%s}{\\textsf{\\sc %s} %d})",
                publication.conference.url,
                publication.conference.acronym,
                publication.conference.year
            )
        end
        table.insert(publications_strs, publication_str)
    end
    return publications_strs
end

local utils = require 'utils'
tex.sprint(table.concat(render_publications(utils.load_db("../db/publications.json")), "\\\\\\\\"))

tex.sprint([[\end{longtabu}]])
\end{luacode*}
